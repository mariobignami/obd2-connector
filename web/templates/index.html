<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OBD2 Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:       #0d1117;
    --surface:  #161b22;
    --border:   #21262d;
    --accent:   #00ff88;
    --accent2:  #00d4aa;
    --warn:     #ff9500;
    --danger:   #ff3b30;
    --text:     #e6edf3;
    --muted:    #7d8590;
    --glow:     0 0 12px rgba(0,255,136,.35);
    --glow2:    0 0 20px rgba(0,212,170,.25);
    --glow-warn: 0 0 14px rgba(255,149,0,.45);
  }
  * { box-sizing:border-box; margin:0; padding:0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', 'Segoe UI', sans-serif;
    font-size: 15px;
    min-height: 100vh;
  }

  /* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 100;
  }
  .topbar-logo {
    font-family: 'Orbitron', monospace;
    font-size: 1.3rem;
    font-weight: 900;
    color: var(--accent);
    text-shadow: var(--glow);
    letter-spacing: 2px;
  }
  .topbar-status {
    display: flex; gap: 20px; align-items: center;
    font-size: 0.85rem; color: var(--muted);
  }
  .status-dot {
    display: inline-block;
    width: 9px; height: 9px;
    border-radius: 50%;
    background: var(--muted);
    margin-right: 5px;
    transition: background .3s;
  }
  .status-dot.connected { background: var(--accent); box-shadow: var(--glow); }
  .demo-badge {
    background: linear-gradient(135deg, #ff9500, #ff6b00);
    color: #fff;
    font-family: 'Orbitron', monospace;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 20px;
    letter-spacing: 1px;
    animation: pulse-warn 2s ease-in-out infinite;
  }
  @keyframes pulse-warn {
    0%,100% { box-shadow: 0 0 6px rgba(255,149,0,.4); }
    50%      { box-shadow: 0 0 18px rgba(255,149,0,.8); }
  }

  /* â”€â”€ ACTIONS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .actions {
    display: flex; flex-wrap: wrap; gap: 8px;
    padding: 12px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    align-items: center;
  }
  .actions-group {
    display: flex; gap: 8px; align-items: center;
  }
  .actions-divider {
    width: 1px; height: 28px;
    background: var(--border);
    margin: 0 4px;
  }
  .btn {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    letter-spacing: .5px;
    padding: 7px 16px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: transparent;
    color: var(--text);
    cursor: pointer;
    transition: all .2s;
    white-space: nowrap;
  }
  .btn:hover { border-color: var(--accent2); color: var(--accent2); box-shadow: var(--glow2); }
  .btn-primary { border-color: var(--accent); color: var(--accent); }
  .btn-primary:hover { background: rgba(0,255,136,.08); box-shadow: var(--glow); }
  .btn-warn { border-color: var(--warn); color: var(--warn); }
  .btn-warn:hover { background: rgba(255,149,0,.08); box-shadow: var(--glow-warn); }
  .btn-danger { border-color: var(--danger); color: var(--danger); }
  .btn-danger:hover { background: rgba(255,59,48,.08); }

  /* â”€â”€ MAIN GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  main { padding: 24px; }
  .section-title {
    font-family: 'Orbitron', monospace;
    font-size: 0.75rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 14px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .section-title .title-badge {
    font-size: 0.65rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 700;
    letter-spacing: 1px;
  }
  .gauge-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 14px;
    margin-bottom: 28px;
  }

  /* â”€â”€ GAUGE CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gauge-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 14px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: border-color .3s, box-shadow .3s;
  }
  .gauge-card:hover { border-color: var(--accent2); box-shadow: var(--glow2); }
  .gauge-label {
    font-size: 0.72rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 10px;
    text-align: center;
  }

  /* SVG arc gauge */
  .arc-gauge { position: relative; width: 130px; height: 74px; overflow: visible; }
  .arc-track { stroke: var(--border); stroke-width: 10; fill: none; }
  .arc-fill  { stroke: var(--accent); stroke-width: 10; fill: none;
               stroke-linecap: round; transition: stroke-dashoffset .6s ease; }
  .arc-fill.warn   { stroke: var(--warn); }
  .arc-fill.danger { stroke: var(--danger); }

  .gauge-value {
    font-family: 'Orbitron', monospace;
    font-size: 1.45rem;
    font-weight: 700;
    color: var(--accent);
    margin-top: 4px;
    transition: color .3s;
    text-shadow: var(--glow);
    letter-spacing: 1px;
  }
  .gauge-value.warn   { color: var(--warn); text-shadow: 0 0 10px rgba(255,149,0,.4); }
  .gauge-value.danger { color: var(--danger); text-shadow: 0 0 10px rgba(255,59,48,.4); }
  .gauge-unit {
    font-size: 0.72rem;
    color: var(--muted);
    margin-top: 2px;
    letter-spacing: 1px;
  }

  /* â”€â”€ STATS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-section { margin-bottom: 28px; }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 10px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: border-color .3s;
  }
  .stat-card:hover { border-color: var(--accent2); }
  .stat-label {
    font-size: 0.78rem;
    letter-spacing: .5px;
    text-transform: uppercase;
    color: var(--muted);
  }
  .stat-value {
    font-family: 'Orbitron', monospace;
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--accent2);
    letter-spacing: 1px;
    text-align: right;
  }
  .stat-unit {
    font-size: 0.7rem;
    color: var(--muted);
    text-align: right;
    margin-top: 1px;
  }

  /* â”€â”€ DTC SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .dtc-section { margin-bottom: 28px; }
  .dtc-status-bar {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 12px;
    font-size: 0.88rem;
  }
  .dtc-status-icon { font-size: 1.3rem; }
  .dtc-status-text { flex: 1; }
  .dtc-status-ok   { color: var(--accent); border-color: rgba(0,255,136,.2); }
  .dtc-status-warn { color: var(--warn);   border-color: rgba(255,149,0,.3); background: rgba(255,149,0,.05); }
  .dtc-list {
    display: flex; flex-wrap: wrap; gap: 10px;
    min-height: 42px;
    align-items: flex-start;
  }
  .dtc-badge {
    font-family: 'Orbitron', monospace;
    font-size: 0.82rem;
    background: rgba(255,59,48,.10);
    border: 1px solid rgba(255,59,48,.4);
    color: var(--danger);
    padding: 8px 14px;
    border-radius: 10px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all .2s;
    min-width: 110px;
  }
  .dtc-badge:hover { background: rgba(255,59,48,.20); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,59,48,.2); }
  .dtc-badge-desc {
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.72rem;
    color: var(--muted);
    margin-top: 4px;
    letter-spacing: 0;
    line-height: 1.35;
  }
  .dtc-badge-cat {
    font-size: 0.65rem;
    color: rgba(255,149,0,.8);
    margin-top: 2px;
    letter-spacing: .5px;
  }
  .dtc-badge-pending {
    background: rgba(255,149,0,.10);
    border-color: rgba(255,149,0,.4);
    color: var(--warn);
  }
  .dtc-badge-pending:hover { background: rgba(255,149,0,.18); }
  .dtc-empty {
    font-size: 0.88rem;
    color: var(--accent);
    padding: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* â”€â”€ TERMINAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .terminal-section { margin-bottom: 10px; }
  .terminal-box {
    background: #010409;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    font-family: 'Courier New', monospace;
    font-size: 0.82rem;
    color: #adbac7;
    min-height: 110px;
    max-height: 220px;
    overflow-y: auto;
    margin-bottom: 10px;
    line-height: 1.55;
  }
  .terminal-box .t-prompt { color: var(--accent2); }
  .terminal-box .t-resp   { color: #adbac7; }
  .terminal-box .t-err    { color: var(--danger); }
  .terminal-input-row { display: flex; gap: 8px; }
  .terminal-input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    padding: 8px 12px;
    outline: none;
    transition: border-color .2s;
  }
  .terminal-input:focus { border-color: var(--accent2); }
  .terminal-input::placeholder { color: var(--muted); }

  /* â”€â”€ VEHICLE INFO TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #vehicle-info-table td {
    padding: 7px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }
  #vehicle-info-table td:first-child {
    color: var(--muted);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    width: 180px;
  }

  /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  footer {
    text-align: center;
    padding: 14px;
    font-size: 0.75rem;
    color: var(--muted);
    border-top: 1px solid var(--border);
  }

  /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #toast {
    position: fixed;
    bottom: 24px; right: 24px;
    background: var(--surface);
    border: 1px solid var(--accent2);
    color: var(--accent2);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    opacity: 0;
    transform: translateY(10px);
    transition: all .3s;
    pointer-events: none;
    z-index: 999;
  }
  #toast.show { opacity: 1; transform: translateY(0); }

  /* â”€â”€ MIL BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #mil-badge {
    padding: 7px 16px;
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 700;
    display: none;
    cursor: pointer;
  }
  #mil-badge.mil-on  { background: rgba(255,59,48,.18); color: var(--danger); border: 1px solid rgba(255,59,48,.5); animation: pulse-warn 2s ease-in-out infinite; }
  #mil-badge.mil-off { background: rgba(0,255,136,.08); color: var(--accent); border: 1px solid rgba(0,255,136,.3); }
</style>
</head>
<body>

<!-- â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="topbar">
  <div class="topbar-logo">â¬¡ OBD2</div>
  <div class="topbar-status">
    {% if demo %}<span class="demo-badge">DEMO MODE</span>{% endif %}
    <span><span class="status-dot" id="dot"></span><span id="status-text">Connectingâ€¦</span></span>
    <span id="status-port" style="color:var(--text)">â€”</span>
    <span id="status-mode" style="color:var(--muted)">â€”</span>
  </div>
</header>

<!-- â”€â”€ ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="actions">
  <div class="actions-group">
    <button class="btn btn-primary" onclick="scanAll()">âŸ³ Scan All</button>
    <button class="btn" id="stream-btn" onclick="toggleStream()">â–¶ Live Stream</button>
    <button class="btn" onclick="loadVehicleInfo()">ğŸš— Vehicle Info</button>
    <button class="btn" onclick="exportCSV()">â†“ Export CSV</button>
  </div>
  <div class="actions-divider"></div>
  <div class="actions-group">
    <button class="btn btn-warn" onclick="readDTC()" title="Ler falhas armazenadas (Modo 03)">âš  Ler Erros</button>
    <button class="btn" onclick="readPendingDTC()" title="Ler falhas pendentes (Modo 07)" style="border-color:var(--warn);color:var(--warn);opacity:.75">ğŸ“‹ Pendentes</button>
    <button class="btn btn-danger" onclick="clearDTC()" title="Apagar todos os cÃ³digos de falha (Modo 04)">âœ• Limpar Erros</button>
  </div>
  <span id="mil-badge" onclick="readDTC()"></span>
</div>

<!-- â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main>

  <!-- DTC Status banner (always visible) -->
  <div id="dtc-status-bar" class="dtc-status-bar" style="display:none;">
    <span class="dtc-status-icon" id="dtc-status-icon">âš </span>
    <span class="dtc-status-text" id="dtc-status-text"></span>
    <button class="btn btn-warn" onclick="readDTC()" style="padding:4px 12px;font-size:0.78rem;">Ver Detalhes</button>
  </div>

  <!-- Sensor Gauges -->
  <p class="section-title">ğŸ“Š Leituras dos Sensores</p>
  <div class="gauge-grid" id="gauge-grid">
    <!-- cards injected by JS -->
  </div>

  <!-- Trip & Statistics -->
  <p class="section-title">ğŸ—º Computador de Bordo &amp; EstatÃ­sticas</p>
  <div class="stats-grid" id="stats-grid">
    <!-- stat cards injected by JS -->
  </div>

  <!-- DTC Section -->
  <div class="dtc-section" id="dtc-section">
    <p class="section-title">
      âš  DiagnÃ³stico â€“ CÃ³digos de Falha (DTC)
      <span id="dtc-count-badge" class="title-badge" style="display:none;background:rgba(255,59,48,.15);color:var(--danger);border:1px solid rgba(255,59,48,.3);"></span>
    </p>
    <div class="dtc-list" id="dtc-list">
      <span class="dtc-empty">
        <span style="color:var(--muted)">â€”</span>
        <span style="color:var(--muted)">Nenhum cÃ³digo lido ainda â€” clique em <strong style="color:var(--warn)">âš  Ler Erros</strong></span>
      </span>
    </div>
  </div>

  <!-- Vehicle Info -->
  <div class="dtc-section" id="vehicle-info-section" style="display:none;">
    <p class="section-title">ğŸªª InformaÃ§Ãµes do VeÃ­culo</p>
    <table id="vehicle-info-table" style="width:100%;border-collapse:collapse;font-size:0.9rem;">
    </table>
  </div>

  <!-- Terminal -->
  <div class="terminal-section">
    <p class="section-title">ğŸ’» Terminal de Comandos</p>
    <div class="terminal-box" id="terminal">
      <span class="t-resp">// Terminal OBD2 pronto â€” digite comandos AT ou OBD2 abaixo</span><br/>
    </div>
    <div class="terminal-input-row">
      <input class="terminal-input" id="term-input" placeholder="ex: AT RV  ou  010C  ou  03" onkeydown="termKeydown(event)"/>
      <button class="btn btn-primary" onclick="termSend()">Enviar</button>
    </div>
  </div>
</main>

<footer>OBD2 Dashboard &nbsp;Â·&nbsp; ELM327 Bluetooth/USB &nbsp;Â·&nbsp; <span id="last-update">â€”</span></footer>
<div id="toast"></div>

<script>
// â”€â”€ GAUGE DEFINITIONS (all OBD sensors, matching CLI dash) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GAUGES = [
  { key:'rpm',              label:'RPM do Motor',          min:0,   max:8000,  warnAt:5500,  dangerAt:7000, invertWarn:false },
  { key:'speed',            label:'Velocidade',            min:0,   max:220,   warnAt:160,   dangerAt:200,  invertWarn:false },
  { key:'coolant_temp',     label:'Temp. Arrefecimento',   min:50,  max:130,   warnAt:105,   dangerAt:115,  invertWarn:false },
  { key:'engine_load',      label:'Carga do Motor',        min:0,   max:100,   warnAt:75,    dangerAt:90,   invertWarn:false },
  { key:'throttle',         label:'Acelerador',            min:0,   max:100,   warnAt:80,    dangerAt:95,   invertWarn:false },
  { key:'fuel_level',       label:'NÃ­vel de CombustÃ­vel',  min:0,   max:100,   warnAt:15,    dangerAt:8,    invertWarn:true  },
  { key:'intake_temp',      label:'Temp. AdmissÃ£o',        min:0,   max:80,    warnAt:50,    dangerAt:65,   invertWarn:false },
  { key:'maf',              label:'Sensor MAF',            min:0,   max:50,    warnAt:35,    dangerAt:45,   invertWarn:false },
  { key:'timing_advance',   label:'AvanÃ§o de IgniÃ§Ã£o',     min:-20, max:60,    warnAt:50,    dangerAt:55,   invertWarn:false },
  { key:'voltage',          label:'TensÃ£o da Bateria',     min:8,   max:16,    warnAt:11.5,  dangerAt:10.5, invertWarn:true  },
  { key:'oil_temp',         label:'Temp. do Ã“leo',         min:40,  max:150,   warnAt:120,   dangerAt:135,  invertWarn:false },
  { key:'map',              label:'PressÃ£o Coletor (MAP)', min:0,   max:255,   warnAt:220,   dangerAt:245,  invertWarn:false },
  { key:'fuel_rate',        label:'Consumo InstantÃ¢neo',   min:0,   max:30,    warnAt:20,    dangerAt:27,   invertWarn:false },
  { key:'short_fuel_trim_1',label:'Trim Comb. Curto (B1)', min:-30, max:30,    warnAt:20,    dangerAt:25,   invertWarn:false },
  { key:'long_fuel_trim_1', label:'Trim Comb. Longo (B1)', min:-30, max:30,    warnAt:15,    dangerAt:20,   invertWarn:false },
  { key:'baro_pressure',    label:'PressÃ£o BaromÃ©trica',   min:60,  max:110,   warnAt:105,   dangerAt:108,  invertWarn:false },
  { key:'ambient_temp',     label:'Temp. Ambiente',        min:-20, max:60,    warnAt:45,    dangerAt:55,   invertWarn:false },
  { key:'abs_load',         label:'Carga Absoluta',        min:0,   max:100,   warnAt:85,    dangerAt:95,   invertWarn:false },
];

// â”€â”€ STATS (trip/runtime sensors shown as table) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STATS = [
  { key:'runtime',            label:'Tempo de Funcionamento', unit:'s'     },
  { key:'distance_mil',       label:'DistÃ¢ncia c/ MIL Ligada', unit:'km'  },
  { key:'distance_since_clr', label:'Dist. desde Limpeza DTC', unit:'km'  },
  { key:'warmups_since_clr',  label:'Aquecimentos desde Limpeza', unit:'' },
  { key:'evap_pressure',      label:'PressÃ£o Evap. Sistema',  unit:'Pa'   },
];

// â”€â”€ DTC DESCRIPTIONS (most common codes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DTC_DESCRIPTIONS = {
  // MAF
  'P0100':'Defeito no circuito do sensor MAF','P0101':'MAF fora da faixa/desempenho','P0102':'MAF â€“ sinal baixo','P0103':'MAF â€“ sinal alto','P0104':'MAF â€“ sinal intermitente',
  // IAT
  'P0110':'Defeito no sensor de temperatura de admissÃ£o (IAT)','P0112':'IAT â€“ sinal baixo','P0113':'IAT â€“ sinal alto',
  // Coolant
  'P0115':'Defeito no sensor de temperatura do arrefecimento (ECT)','P0116':'ECT fora da faixa/desempenho','P0117':'ECT â€“ sinal baixo','P0118':'ECT â€“ sinal alto',
  // TPS
  'P0120':'Defeito no sensor de posiÃ§Ã£o do acelerador (TPS)','P0121':'TPS fora da faixa/desempenho','P0122':'TPS â€“ sinal baixo','P0123':'TPS â€“ sinal alto',
  // O2 sensors
  'P0130':'Defeito no sensor O2 (Banco 1, Sensor 1)','P0131':'O2 B1S1 â€“ tensÃ£o baixa','P0132':'O2 B1S1 â€“ tensÃ£o alta','P0133':'O2 B1S1 â€“ resposta lenta','P0134':'O2 B1S1 â€“ sem atividade','P0135':'Aquecedor O2 B1S1 â€“ defeito','P0136':'Defeito no sensor O2 (B1S2)','P0140':'O2 B1S2 â€“ sem atividade','P0141':'Aquecedor O2 B1S2 â€“ defeito','P0143':'O2 B1S3 â€“ tensÃ£o baixa','P0150':'Defeito no sensor O2 (B2S1)',
  // Fuel trim / rich/lean
  'P0171':'Sistema muito pobre (Banco 1)','P0172':'Sistema muito rico (Banco 1)','P0174':'Sistema muito pobre (Banco 2)','P0175':'Sistema muito rico (Banco 2)',
  // INJECTORS (injeÃ§Ã£o)
  'P0200':'Defeito no circuito dos injetores','P0201':'Defeito no injetor â€“ Cilindro 1','P0202':'Defeito no injetor â€“ Cilindro 2','P0203':'Defeito no injetor â€“ Cilindro 3','P0204':'Defeito no injetor â€“ Cilindro 4','P0205':'Defeito no injetor â€“ Cilindro 5','P0206':'Defeito no injetor â€“ Cilindro 6','P0207':'Defeito no injetor â€“ Cilindro 7','P0208':'Defeito no injetor â€“ Cilindro 8',
  // Misfires
  'P0300':'Falha de igniÃ§Ã£o aleatÃ³ria/mÃºltipla','P0301':'Falha de igniÃ§Ã£o â€“ Cilindro 1','P0302':'Falha de igniÃ§Ã£o â€“ Cilindro 2','P0303':'Falha de igniÃ§Ã£o â€“ Cilindro 3','P0304':'Falha de igniÃ§Ã£o â€“ Cilindro 4','P0305':'Falha de igniÃ§Ã£o â€“ Cilindro 5','P0306':'Falha de igniÃ§Ã£o â€“ Cilindro 6',
  // Camshaft
  'P0340':'Defeito no sensor de posiÃ§Ã£o do comando de vÃ¡lvulas','P0341':'Sensor de posiÃ§Ã£o do comando fora da faixa',
  // Ignition coil
  'P0351':'Circuito da bobina de igniÃ§Ã£o A','P0352':'Circuito da bobina de igniÃ§Ã£o B',
  // EGR
  'P0400':'Defeito no fluxo de EGR (recirculaÃ§Ã£o de gases)','P0401':'Fluxo de EGR insuficiente','P0402':'Fluxo de EGR excessivo','P0404':'EGR fora da faixa/desempenho','P0405':'Sensor EGR A â€“ sinal baixo','P0406':'Sensor EGR A â€“ sinal alto',
  // Catalyst
  'P0420':'EficiÃªncia do catalisador abaixo do limite (Banco 1)','P0421':'Catalisador de aquecimento abaixo do limite (B1)','P0430':'EficiÃªncia do catalisador abaixo do limite (Banco 2)',
  // EVAP
  'P0440':'Defeito no sistema de emissÃµes evaporativas','P0441':'Purge flow incorreto no sistema EVAP','P0442':'Vazamento pequeno detectado no sistema EVAP','P0443':'Circuito da vÃ¡lvula de purge EVAP','P0446':'Circuito de ventilaÃ§Ã£o EVAP','P0455':'Vazamento grande detectado no sistema EVAP','P0456':'Vazamento muito pequeno detectado no sistema EVAP',
  // Speed / Idle
  'P0500':'Defeito no sensor de velocidade do veÃ­culo','P0505':'Defeito no sistema de controle do marcha lenta','P0506':'RPM de marcha lenta muito baixo','P0507':'RPM de marcha lenta muito alto',
  // CAN / ECM
  'P0600':'Defeito no link de comunicaÃ§Ã£o serial','P0601':'Defeito na memÃ³ria do ECM (ROM)','P0602':'ECM â€“ erro de programaÃ§Ã£o',
  // Transmission
  'P0700':'Defeito no sistema de controle da transmissÃ£o','P0705':'Sensor de faixa da transmissÃ£o â€“ defeito','P0710':'Sensor de temperatura do fluido da transmissÃ£o','P0715':'Sensor de velocidade da turbina â€“ defeito','P0720':'Sensor de velocidade de saÃ­da â€“ defeito','P0730':'RelaÃ§Ã£o de marcha incorreta','P0740':'Defeito na embreagem do conversor de torque',
};

const DTC_SYSTEMS = { 'P':'Powertrain','C':'Chassis','B':'Body','U':'Network' };
const DTC_TYPES   = { '0':'GenÃ©rico','1':'Fabricante','2':'GenÃ©rico','3':'Fabricante' };

function getDTCInfo(code) {
  const system = DTC_SYSTEMS[code[0]] || 'Desconhecido';
  const type   = DTC_TYPES[code[1]]   || '';
  const desc   = DTC_DESCRIPTIONS[code] || null;
  return { system, type, desc };
}

// â”€â”€ ARC GAUGE GEOMETRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CX = 65, CY = 65, R = 50;
const ARC_LEN = Math.PI * R;

function buildGaugeCard(g) {
  const card = document.createElement('div');
  card.className = 'gauge-card';
  card.innerHTML = `
    <div class="gauge-label">${g.label}</div>
    <svg class="arc-gauge" viewBox="0 0 130 72">
      <path class="arc-track" d="M ${CX-R} ${CY} A ${R} ${R} 0 0 1 ${CX+R} ${CY}"/>
      <path class="arc-fill" id="arc-${g.key}"
            d="M ${CX-R} ${CY} A ${R} ${R} 0 0 1 ${CX+R} ${CY}"
            stroke-dasharray="${ARC_LEN}"
            stroke-dashoffset="${ARC_LEN}"/>
    </svg>
    <div class="gauge-value" id="val-${g.key}">â€”</div>
    <div class="gauge-unit"  id="unit-${g.key}"></div>
  `;
  return card;
}

function initGauges() {
  const grid = document.getElementById('gauge-grid');
  GAUGES.forEach(g => grid.appendChild(buildGaugeCard(g)));
}

function updateGauge(g, value, unit) {
  const valEl  = document.getElementById(`val-${g.key}`);
  const arcEl  = document.getElementById(`arc-${g.key}`);
  const unitEl = document.getElementById(`unit-${g.key}`);
  if (value === null || value === undefined) return;

  const span = g.max - g.min;
  const pct  = Math.max(0, Math.min(1, (value - g.min) / span));
  arcEl.style.strokeDashoffset = ARC_LEN * (1 - pct);

  let cls = '';
  if (g.invertWarn) {
    if (value <= g.dangerAt) cls = 'danger';
    else if (value <= g.warnAt) cls = 'warn';
  } else {
    if (value >= g.dangerAt) cls = 'danger';
    else if (value >= g.warnAt) cls = 'warn';
  }
  arcEl.className = 'arc-fill' + (cls ? ' ' + cls : '');
  valEl.className = 'gauge-value' + (cls ? ' ' + cls : '');

  const disp = typeof value === 'number' ? (Number.isInteger(value) ? value : value.toFixed(1)) : value;
  valEl.textContent = disp;
  unitEl.textContent = unit || '';
}

// â”€â”€ STATS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initStats() {
  const grid = document.getElementById('stats-grid');
  STATS.forEach(s => {
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
      <div>
        <div class="stat-label">${s.label}</div>
      </div>
      <div>
        <div class="stat-value" id="stat-${s.key}">â€”</div>
        <div class="stat-unit">${s.unit}</div>
      </div>
    `;
    grid.appendChild(card);
  });
}

function updateStats(sensors) {
  STATS.forEach(s => {
    const el = document.getElementById(`stat-${s.key}`);
    if (!el) return;
    const d = sensors[s.key];
    if (d && d.value !== null && d.value !== undefined) {
      el.textContent = typeof d.value === 'number' ? (Number.isInteger(d.value) ? d.value : d.value.toFixed(1)) : d.value;
    }
  });
}

// â”€â”€ SENSOR DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applySensorData(sensors) {
  GAUGES.forEach(g => {
    const s = sensors[g.key];
    if (s) updateGauge(g, s.value, s.unit);
  });
  updateStats(sensors);
  document.getElementById('last-update').textContent = 'Ãšltima atualizaÃ§Ã£o: ' + new Date().toLocaleTimeString('pt-BR');
}

async function scanAll() {
  showToast('Lendo sensoresâ€¦');
  try {
    const r = await fetch('/api/sensors');
    const d = await r.json();
    applySensorData(d.sensors || {});
    showToast('Leitura completa âœ“');
  } catch(e) { showToast('Falha na leitura: ' + e, true); }
}

// â”€â”€ STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateStatus() {
  try {
    const r = await fetch('/api/status');
    const d = await r.json();
    const dot = document.getElementById('dot');
    const txt = document.getElementById('status-text');
    dot.className = 'status-dot' + (d.connected ? ' connected' : '');
    txt.textContent = d.connected ? 'Conectado' : 'Desconectado';
    document.getElementById('status-port').textContent = d.port || 'â€”';
    document.getElementById('status-mode').textContent = d.mode || 'â€”';
  } catch(_) {}
}

// â”€â”€ DTC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _renderDTCList(codes, pending, scrollOnFound) {
  const el = document.getElementById('dtc-list');
  const badge = document.getElementById('dtc-count-badge');
  const statusBar = document.getElementById('dtc-status-bar');
  const statusText = document.getElementById('dtc-status-text');
  const statusIcon = document.getElementById('dtc-status-icon');

  if (!codes || codes.length === 0) {
    el.innerHTML = `<span class="dtc-empty">âœ“ Nenhum cÃ³digo de falha ${pending ? 'pendente' : 'armazenado'} encontrado</span>`;
    badge.style.display = 'none';
    if (!pending) {
      statusBar.style.display = '';
      statusBar.className = 'dtc-status-bar dtc-status-ok';
      statusIcon.textContent = 'âœ“';
      statusText.textContent = 'Sistema sem falhas â€” nenhum DTC armazenado';
    }
  } else {
    const label = pending ? 'pendente' : 'armazenado';
    el.innerHTML = codes.map(c => {
      const info = getDTCInfo(c);
      const descLine = info.desc
        ? `<div class="dtc-badge-desc">${info.desc}</div>`
        : `<div class="dtc-badge-desc">${info.system} â€“ ${info.type}</div>`;
      const catLine = `<div class="dtc-badge-cat">${info.system.toUpperCase()} Â· ${info.type.toUpperCase()}</div>`;
      return `<div class="dtc-badge ${pending ? 'dtc-badge-pending' : ''}" title="Clique para pesquisar" onclick="searchDTC('${c}')">${c}${catLine}${descLine}</div>`;
    }).join('');
    badge.style.display = '';
    badge.textContent = `${codes.length} cÃ³digo${codes.length > 1 ? 's' : ''} ${label}${codes.length > 1 ? 's' : ''}`;
    if (!pending) {
      statusBar.style.display = '';
      statusBar.className = 'dtc-status-bar dtc-status-warn';
      statusIcon.textContent = 'âš ';
      statusText.innerHTML = `<strong>${codes.length} falha${codes.length > 1 ? 's' : ''} armazenada${codes.length > 1 ? 's' : ''}</strong> â€” clique em "Ver Detalhes" ou role a pÃ¡gina atÃ© a seÃ§Ã£o de diagnÃ³stico`;
    }
    // Scroll only when explicitly requested (not on clearDTC or live-stream updates)
    if (scrollOnFound) {
      document.getElementById('dtc-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }
}

async function readDTC() {
  const el = document.getElementById('dtc-list');
  el.innerHTML = '<span style="color:var(--muted)">Lendo falhas armazenadasâ€¦</span>';
  try {
    const r = await fetch('/api/dtc');
    const d = await r.json();
    _renderDTCList(d.codes, false, true);
    if (d.codes && d.codes.length > 0) {
      showToast(`âš  ${d.codes.length} cÃ³digo${d.codes.length > 1 ? 's' : ''} encontrado${d.codes.length > 1 ? 's' : ''}`, true);
    } else {
      showToast('Sem falhas armazenadas âœ“');
    }
  } catch(e) {
    el.innerHTML = `<span style="color:var(--danger)">Erro: ${e}</span>`;
    showToast('Erro ao ler DTCs', true);
  }
}

async function readPendingDTC() {
  const el = document.getElementById('dtc-list');
  el.innerHTML = '<span style="color:var(--muted)">Lendo falhas pendentesâ€¦</span>';
  try {
    const r = await fetch('/api/dtc/pending');
    const d = await r.json();
    _renderDTCList(d.codes, true, true);
    if (d.codes && d.codes.length > 0) {
      showToast(`ğŸ“‹ ${d.codes.length} cÃ³digo${d.codes.length > 1 ? 's' : ''} pendente${d.codes.length > 1 ? 's' : ''}`, true);
    } else {
      showToast('Sem falhas pendentes âœ“');
    }
  } catch(e) {
    el.innerHTML = `<span style="color:var(--danger)">Erro: ${e}</span>`;
  }
}

async function clearDTC() {
  if (!confirm('Apagar todos os cÃ³digos de falha armazenados?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.')) return;
  try {
    const r = await fetch('/api/dtc/clear', {method:'POST'});
    const d = await r.json();
    if (d.success) {
      showToast('Falhas apagadas âœ“');
      document.getElementById('dtc-list').innerHTML =
        '<span class="dtc-empty">âœ“ Todos os DTCs foram apagados com sucesso</span>';
      document.getElementById('dtc-count-badge').style.display = 'none';
      const statusBar = document.getElementById('dtc-status-bar');
      statusBar.style.display = '';
      statusBar.className = 'dtc-status-bar dtc-status-ok';
      document.getElementById('dtc-status-icon').textContent = 'âœ“';
      document.getElementById('dtc-status-text').textContent = 'DTCs apagados â€” faÃ§a um novo scan para confirmar';
    } else {
      showToast('Falha ao apagar DTCs', true);
    }
  } catch(e) { showToast('Erro: ' + e, true); }
}

function searchDTC(code) {
  window.open(`https://www.google.com/search?q=OBD2+DTC+${code}+significado`, '_blank', 'noopener,noreferrer');
}

// â”€â”€ MIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkMIL() {
  try {
    const r = await fetch('/api/mil');
    const d = await r.json();
    const badge = document.getElementById('mil-badge');
    if (d.mil_on === null || d.mil_on === undefined) { badge.style.display = 'none'; return; }
    badge.style.display = '';
    if (d.mil_on) {
      badge.textContent = `âš  CHECK ENGINE (${d.dtc_count} cÃ³d.)`;
      badge.className = 'mil-on';
    } else {
      badge.textContent = `âœ“ MOTOR OK`;
      badge.className = 'mil-off';
    }
  } catch(_) {}
}

// â”€â”€ VEHICLE INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadVehicleInfo() {
  const section = document.getElementById('vehicle-info-section');
  const tbl = document.getElementById('vehicle-info-table');
  tbl.innerHTML = '<tr><td colspan="2" style="color:var(--muted);padding:10px">Carregandoâ€¦</td></tr>';
  section.style.display = '';
  section.scrollIntoView({ behavior:'smooth', block:'nearest' });
  try {
    const r = await fetch('/api/vehicle_info');
    const d = await r.json();
    if (d.error) { tbl.innerHTML = `<tr><td colspan="2" style="color:var(--danger)">${d.error}</td></tr>`; return; }
    const fields = [
      ['VIN', d.vin],['Nome ECU', d.ecu_name],['ID CalibraÃ§Ã£o', d.calibration_id],
      ['Protocolo OBD', d.protocol],['VersÃ£o ELM327', d.elm_version],['TensÃ£o Bateria', d.battery_voltage],
    ];
    tbl.innerHTML = fields.map(([k,v]) =>
      `<tr><td>${k}</td><td style="font-family:'Orbitron',monospace;font-size:0.82rem;color:var(--accent2)">${v||'N/A'}</td></tr>`
    ).join('');
  } catch(e) { tbl.innerHTML = `<tr><td colspan="2" style="color:var(--danger)">Erro: ${e}</td></tr>`; }
}

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  window.location.href = '/api/export';
  showToast('Baixando CSVâ€¦');
}

// â”€â”€ LIVE STREAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let evtSource = null;
function toggleStream() {
  const btn = document.getElementById('stream-btn');
  if (evtSource) {
    evtSource.close(); evtSource = null;
    btn.textContent = 'â–¶ Live Stream';
    btn.classList.remove('btn-primary');
  } else {
    evtSource = new EventSource('/api/stream');
    evtSource.onmessage = e => {
      try {
        const d = JSON.parse(e.data);
        if (d.sensors) applySensorData(d.sensors);
        if (d.status)  applyStatus(d.status);
      } catch(_) {}
    };
    evtSource.onerror = () => {
      evtSource.close(); evtSource = null;
      btn.textContent = 'â–¶ Live Stream';
      btn.classList.remove('btn-primary');
    };
    btn.textContent = 'â¹ Parar Stream';
    btn.classList.add('btn-primary');
    showToast('Stream ao vivo iniciado');
  }
}

function applyStatus(s) {
  const dot = document.getElementById('dot');
  const txt = document.getElementById('status-text');
  dot.className = 'status-dot' + (s.connected ? ' connected' : '');
  txt.textContent = s.connected ? 'Conectado' : 'Desconectado';
  document.getElementById('status-port').textContent = s.port || 'â€”';
  document.getElementById('status-mode').textContent = s.mode || 'â€”';
}

// â”€â”€ TERMINAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const term = document.getElementById('terminal');

function termAppend(html) {
  term.innerHTML += html + '<br/>';
  term.scrollTop = term.scrollHeight;
}

function termKeydown(e) {
  if (e.key === 'Enter') termSend();
}

async function termSend() {
  const inp = document.getElementById('term-input');
  const cmd = inp.value.trim();
  if (!cmd) return;
  inp.value = '';
  termAppend(`<span class="t-prompt">Â» ${cmd}</span>`);
  try {
    const r = await fetch('/api/command', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({command: cmd})
    });
    const d = await r.json();
    if (d.error) termAppend(`<span class="t-err">ERRO: ${d.error}</span>`);
    else termAppend(`<span class="t-resp">${(d.response||'(sem resposta)').replace(/\n/g,'<br/>')}</span>`);
  } catch(e) {
    termAppend(`<span class="t-err">Erro de conexÃ£o: ${e}</span>`);
  }
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer = null;
function showToast(msg, isErr=false) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.borderColor = isErr ? 'var(--danger)' : 'var(--accent2)';
  el.style.color = isErr ? 'var(--danger)' : 'var(--accent2)';
  el.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3500);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initGauges();
initStats();
updateStatus();
scanAll();
checkMIL();
// Auto-start live stream after initial scan
setTimeout(toggleStream, 800);
</script>
</body>
</html>
